---
title: "322 Study Design Project"
author: "Kathleen Zhang, Yura Heo"
date: "October 20th, 2025"
format: 
  pdf:
    documentclass: article
    fontsize: 11pt
geometry: margin=1in
execute: 
  warning: false
  message: false
  echo: false
---

```{r}
library(tidyverse)
library(dplyr)
library(readr)
library(stringr)
library(tibble)
library(survey)
set.seed(322)
```

# 1.

**What is an estimate of the total number of undergraduate students enrolled in colleges? Design your survey with the goal of answering this question most accurately.**

```{r}

strata_plan <- tribble(
  ~type,    ~size,   ~Nh,  ~nh,
  "Public", "Small",   824,  9,
  "Public", "Medium",  861, 10,
  "Public", "Large",   176,  2,
  "Private","Small",  3130, 35,
  "Private","Medium",  381,  4,
  "Private","Large",    23,  1
) # based on proportional allocation, sums to 60

sample_index_df <- strata_plan %>%
  rowwise() %>%
  mutate(sampled_index = list(sample.int(Nh, size = nh, replace = FALSE))) %>%
  tidyr::unnest(sampled_index) %>%
  ungroup()

# Leave name and undergrad_enrollment blank/NA to enter later.
template <- sample_index_df %>%
  mutate(
    stratum = paste(type, size, sep = "_"),
    weight  = Nh / nh,   # HT weight for each sampled unit in stratum
    fpc     = Nh         # finite population correction (for variance)
  ) %>%
  select(stratum, type, size, Nh, nh, sampled_index, weight, fpc) %>%
  mutate(
    school_name = "",               # <-- fill manually
    undergrad_enrollment = NA_real_, # <-- fill manually
  )

write_csv(template, "question 1.csv")

```

We estimated the total number of U.S. undergraduates using a stratified simple random sample from the College Scorecard. We defined six strata by crossing school type (Public vs. Private, where Private combines non-profit and for-profit) with size (Small, Medium, Large). For each stratum, we constructed a sampling frame directly from the Scorecard search pages filtered to undergraduate-granting programs, then randomly sampled institutions within stratum. We recorded each sampled school’s undergraduate enrollment and used a Horvitz–Thompson estimator for the population total with stratum weights $w_h = N_h/n_h$ and finite population corrections $N_h$. Because one of the strata (Private–Large) contained only a single sampled institution, a lonely PSU adjustment was applied using the "adjust" method in the survey package. This method inflates the estimated variance slightly to account for strata with only one primary sampling unit (PSU), providing a more conservative and reliable confidence interval.

Stratifying by both sector and size is reasonable because these are key determinants of enrollment variation across U.S. colleges. Public and private institutions differ substantially in average enrollment, and within each sector, small, medium, and large schools have relatively homogeneous student counts. Using six strata therefore reduces variability within each group while capturing meaningful differences across groups.

```{r}

options(survey.lonely.psu = "adjust")

df <- read_csv("datas.csv", show_col_types = FALSE) %>%
  mutate(
    # ensure expected types
    type = as.factor(type),
    median_earnings = as.numeric(median_earnings),
    weight = as.numeric(weight),
    fpc = as.numeric(fpc)
  )

# Survey design: stratified SRS with your stratum labels, weights, and FPCs
des <- svydesign(
  id     = ~1,
  strata = ~stratum,
  weights= ~weight,
  fpc    = ~fpc,
  data   = df
)

tot_undergrad <- svytotal(~undergrad_enrollment, des, na.rm = TRUE)
tot_undergrad
confint(tot_undergrad)


```

The Horvitz–Thompson estimator produced an estimated total undergraduate enrollment of 15,598,354 students, with a standard error (SE) of approximately 1,786,576. The 95% confidence interval for the total enrollment ranges from 12,096,730 to 19,099,978 students.

# **2**.

**What fraction of colleges have a major in statistical science? Use your sample to estimate this fraction; do not get the answer by filtering the schools.**

```{r}

sample_index_df2 <- strata_plan |>
  rowwise() |>
  mutate(sampled_index = list(sample.int(Nh, size = nh, replace = FALSE))) |>
  tidyr::unnest(sampled_index) |>
  ungroup()

template2 <- sample_index_df2 |>
  mutate(
    stratum = paste(type, size, sep = "_"),
    weight  = Nh / nh,   
    fpc     = Nh         
  ) |>
  select(stratum, type, size, Nh, nh, sampled_index, weight, fpc) |>
  mutate(
    school_name = "",               # <-- fill manually
    statistics_major = NA_real_, # <-- fill manually
  )

write_csv(template2, "question 2.csv")

```

```{r}
options(survey.lonely.psu = "adjust")

q2 <- read_csv("question 2.csv", show_col_types = FALSE)

design_q2 <- svydesign(
  id = ~1,
  strata = ~stratum,
  weights = ~weight,
  fpc = ~fpc,
  data = q2
  
  |>
  mutate(invSTUFACR = 1 / STUFACR)

)

fraction_est <- svymean(~statistics_major, design_q2, na.rm = TRUE)
fraction_est
confint(fraction_est)

```

To estimate the fraction of colleges in the United States that offer a major in statistical science, we chose used the same stratified simple random sample from the College Scorecard, using the same six strata of school type (Public and Private) with size (Small, Medium, Large), believing that public vs. private colleges, and small vs. large colleges may offer very different likelihoods of offering a statistics major while having similar academic offerings within strata.

After confirming that the $N_h$ for each stratum were about the same as Question 1 (even after adding Graduate programs to our selection) and therefore the proportional allocation to each $n_h$ would be the same, we used the same random sample of schools from each stratum, recording whether each sampled school offered a major in statistical science (1 if yes, 0 if no). Again, we used a Horvitz–Thompson estimator for the population mean with stratum weights $w_h = N_h/n_h$ and finite population corrections $N_h$, also adjusting for the Private–Large strata that contained only a single sampled institution.

The Horvitz–Thompson estimator produced an estimated 10.4% of colleges in the United States that offer a statistics major, with a standard error (SE) of approximately 2.95%. The 95% confidence interval for the total number of colleges offering a statistics major ranges from 4.62% to 16.2%.

```{r}

survey_main <- read_csv("question 1.csv")
stats_major <- read_csv("question 2.csv")
colleges <- read.csv("colleges.csv")

```

```{r}

colleges <- colleges |>
  select(INSTNM, MD_EARN_WNE_P10, PCTPELL) 

data <- left_join(
  survey_main,
  stats_major |> select(school_name, statistics_major),
  by = "school_name"
)

datas <- data |>
  left_join(colleges, by = c("school_name" = "INSTNM")) |>
  rename(
    pell = PCTPELL,
    median_earnings = MD_EARN_WNE_P10
  )

write_csv(datas, "datas.csv")

```

# **3.**

What is the average of the median earnings among alumni from public schools? From private schools (combine for profit and not for profit private schools)?


```{r}
res_by_type <- svyby(
  ~median_earnings,
  ~type,
  des,
  svymean,
  na.rm   = TRUE,
  vartype = c("se", "ci")
)

out <- res_by_type %>%
  transmute(
    type = as.character(type),
    mean  = median_earnings,
    SE    = se,
    CI_l  = ci_l,
    CI_u  = ci_u
  ) %>%
  mutate(
    across(c(mean, SE, CI_l, CI_u), round, 0)
  )

print(out)
```

Using a stratified simple random sample with proportional allocation, we estimated the average of the median alumni earnings using a stratified simple random sample with proportional allocation, based on the same six strata defined by school type (public vs. private) and size (small, medium, large).

The Horvitz–Thompson estimator produced an estimated average median earning of \$45,650 among alumni from public schools, with a standard error (SE) of approximately \$2,387. The corresponding 95% confidence interval ranges from \$40,971 to \$50,329.

For private schools, the estimated average median earning was \$44,489, with a standard error (SE) of approximately \$3,438. The 95% confidence interval for private-school alumni median earnings ranges from \$37,750 to \$51,228.

# 4.

**Answer one other question that interests you from the data that you could collect from the website.**

```{r}

options(survey.lonely.psu = "adjust")

datas <- datas %>%
  mutate(
    pell_prop = case_when(
      pell > 1               ~ pell / 100,
      pell >= 0 & pell <= 1  ~ pell,
    )
  )

design_q4 <- svydesign(
  id      = ~1,
  strata  = ~stratum,
  weights = ~weight,
  fpc     = ~fpc,
  data    = datas
)

pell_mean <- svymean(~pell_prop, design_q4, na.rm = TRUE)
pell_mean
confint(pell_mean) * 100

coef(pell_mean) * 100

```

To answer an additional question with our stratified sample, we were curious about estimating the mean percentage of undergraduate students who receive Pell grants across U.S. institutions. This is because we believe that Pell grant rates differ systematically across size and type of school- public schools typically enroll more lower-income students, leading to higher Pell grant recipients within said school, while private large universities and elite institutions may have fewer recipients. Our stratified design could give a more precise estimate of Pell recipients.

The data for the percentage of Pell grant recipients for each school in our sample was pulled from the csv on the website titled "Most Recent Institution-Level Data" and was already coded as a decimal. We used the same stratum weights and fpc as in previous questions.

The Horvitz–Thompson estimator produced an estimated mean Pell recipient percentage of 41.7%, with a standard error (SE) of approximately 2.09%. The 95% confidence interval is 37.61% to 45.79%, indicating that, on average, about two in five undergraduates at U.S. colleges in our frame receive Pell grants under this stratified design.
